name: Build luci-app-themeswitch for OpenWrt (Matrix)

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # لیست معماری‌های مورد نظر
        target: [
          "x86_64", "arm_cortex-a9", "arm_cortex-a7", "arm_cortex-a53", "mips_24kc",
          "mipsel_24kc", "aarch64_cortex-a53", "aarch64_cortex-a72", "arm_cortex-a15",
          "arm_cortex-a8", "mips64_octeonplus", "mips64_octeon", "arm_mpcore",
          "arm_cortex-a5", "arm_cortex-a15_neon-vfpv4", "arm_cortex-a7_neon-vfpv4",
          "arm_cortex-a9_vfpv3-d16"
        ]
    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up OpenWrt SDK
      run: |
        SDK_URL="https://downloads.openwrt.org/releases/23.05.0/targets/$(echo ${{ matrix.target }} | sed 's/_/\//')/openwrt-sdk-23.05.0-$(echo ${{ matrix.target }} | tr '_' '-')_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
        wget $SDK_URL -O openwrt-sdk.tar.xz
        mkdir sdk && tar -xJf openwrt-sdk.tar.xz -C sdk --strip-components=1
        cd sdk
        echo "src-git packages https://github.com/openwrt/packages.git" > feeds.conf.default
        echo "src-git luci https://github.com/openwrt/luci.git" >> feeds.conf.default
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Clone luci-app-themeswitch repository
      run: |
        git clone https://github.com/peditx/luci-app-themeswitch.git

    - name: Copy luci-app-themeswitch package
      run: |
        cp -r luci-app-themeswitch ./sdk/package/

    - name: Set default configuration
      run: |
        cd sdk
        make defconfig

    - name: Build luci-app-themeswitch package
      run: |
        cd sdk
        make package/luci-app-themeswitch/compile V=s

    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: luci-app-themeswitch-${{ matrix.target }}-ipk
        path: sdk/bin/packages/*/base/luci-app-themeswitch*.ipk
